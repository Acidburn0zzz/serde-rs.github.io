
<!DOCTYPE HTML>
<html lang="en" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Array of values without buffering Â· Serde</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-codeblock-filename/block.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="enum-str.html" />
    
    
    <link rel="prev" href="serialize-map.html" />
    

    </head>
    <body>
        
<div class="book with-summary font-size-2">
    <div class="book-summary">
        
            
            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="help.html">
            
                <a href="help.html">
            
                    
                    Help
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="codegen.html">
            
                <a href="codegen.html">
            
                    
                    Setting up codegen
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="codegen-stable.html">
            
                <a href="codegen-stable.html">
            
                    
                    On stable compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="codegen-nightly.html">
            
                <a href="codegen-nightly.html">
            
                    
                    On nightly compiler
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="codegen-hybrid.html">
            
                <a href="codegen-hybrid.html">
            
                    
                    Supporting both
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="attributes.html">
            
                <a href="attributes.html">
            
                    
                    Attributes
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="attributes.html">
            
                <a href="attributes.html#container-attributes">
            
                    
                    Container attributes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="attributes.html">
            
                <a href="attributes.html#variant-attributes">
            
                    
                    Variant attributes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="attributes.html">
            
                <a href="attributes.html#field-attributes">
            
                    
                    Field attributes
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="custom-serialization.html">
            
                <a href="custom-serialization.html">
            
                    
                    Custom serialization
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="impl-serialize.html">
            
                <a href="impl-serialize.html">
            
                    
                    Implementing Serialize
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="impl-deserialize.html">
            
                <a href="impl-deserialize.html">
            
                    
                    Implementing Deserialize
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="unit-testing.html">
            
                <a href="unit-testing.html">
            
                    
                    Unit testing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="examples.html">
            
                <a href="examples.html">
            
                    
                    Examples
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="json.html">
            
                <a href="json.html">
            
                    
                    Structs and enums in JSON
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="attr-default.html">
            
                <a href="attr-default.html">
            
                    
                    Default value for a field
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="attr-bound.html">
            
                <a href="attr-bound.html">
            
                    
                    Handwritten generic type bounds
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="deserialize-map.html">
            
                <a href="deserialize-map.html">
            
                    
                    Deserialize for custom map type
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="serialize-map.html">
            
                <a href="serialize-map.html">
            
                    
                    Serialize for custom map type
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.6.6" data-path="stream-array.html">
            
                <a href="stream-array.html">
            
                    
                    Array of values without buffering
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.7" data-path="enum-str.html">
            
                <a href="enum-str.html">
            
                    
                    Serialize enum as string
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.8" data-path="enum-number.html">
            
                <a href="enum-number.html">
            
                    
                    Serialize enum as number
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.9" data-path="attr-rename.html">
            
                <a href="attr-rename.html">
            
                    
                    Serialize fields as camelCase
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.10" data-path="attr-skip-serializing.html">
            
                <a href="attr-skip-serializing.html">
            
                    
                    Skip serializing field
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.11" data-path="newtype-wrapper.html">
            
                <a href="newtype-wrapper.html">
            
                    
                    De/Serialize for other crate
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.12" data-path="deserialize-struct.html">
            
                <a href="deserialize-struct.html">
            
                    
                    Manually deserialize struct
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.13" data-path="trait-objects.html">
            
                <a href="trait-objects.html">
            
                    
                    Trait objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.14" data-path="transcode.html">
            
                <a href="transcode.html">
            
                    
                    Transcode into another format
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.15" data-path="string-or-struct.html">
            
                <a href="string-or-struct.html">
            
                    
                    Either string or struct
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="feature-flags.html">
            
                <a href="feature-flags.html">
            
                    
                    Feature flags
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="release-notes.html">
            
                <a href="release-notes.html">
            
                    
                    Release notes
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="troubleshooting.html">
            
                <a href="troubleshooting.html">
            
                    
                    Troubleshooting
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="technical-details.html">
            
                <a href="technical-details.html">
            
                    
                    Technical details
            
                </a>
            

            
        </li>
    

    
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Array of values without buffering</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                                <section class="normal markdown-section">
                                
                                <h1 id="process-an-array-of-values-without-buffering-into-a-vec">Process an array of values without buffering into a Vec</h1>
<p>Suppose we have an array of integers and we want to figure out the maximum value
without holding the whole array in memory all at once. This approach can be
adapted to handle a variety of other situations in which data needs to be
processed while being deserialized instead of after.</p>
<pre><code class="lang-rust"><span class="hljs-meta">#![feature(proc_macro)]</span>

<span class="hljs-meta">#[macro_use]</span>
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> serde_derive;

<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> serde;
<span class="hljs-keyword">extern</span> <span class="hljs-keyword">crate</span> serde_json;
<span class="hljs-keyword">use</span> serde::{de, Deserialize, Deserializer};

<span class="hljs-keyword">use</span> std::cmp;
<span class="hljs-keyword">use</span> std::marker::PhantomData;

<span class="hljs-meta">#[derive(Deserialize)]</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">Outer</span></span> {
    id: <span class="hljs-built_in">String</span>,

    <span class="hljs-comment">// Deserialize this field by computing the maximum value of a sequence</span>
    <span class="hljs-comment">// (JSON array) of values.</span>
    <span class="hljs-meta">#[serde(deserialize_with = <span class="hljs-meta-string">&quot;deserialize_max&quot;</span>)]</span>
    <span class="hljs-comment">// Despite the struct field being named `max_value`, it is going to come</span>
    <span class="hljs-comment">// from a JSON field called `values`.</span>
    <span class="hljs-meta">#[serde(rename(deserialize = <span class="hljs-meta-string">&quot;values&quot;</span>))]</span>
    max_value: <span class="hljs-keyword">u64</span>,
}

<span class="hljs-comment">/// Deserialize the maximum of a sequence of values. The entire sequence</span>
<span class="hljs-comment">/// is not buffered into memory as it would be if we deserialize to Vec&lt;T&gt;</span>
<span class="hljs-comment">/// and then compute the maximum later.</span>
<span class="hljs-comment">///</span>
<span class="hljs-comment">/// This function is generic over T which can be any type that implements</span>
<span class="hljs-comment">/// Ord. Above, it is used with T=u64.</span>
<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">deserialize_max</span></span>&lt;T, D&gt;(deserializer: &amp;<span class="hljs-keyword">mut</span> D) -&gt; <span class="hljs-built_in">Result</span>&lt;T, D::Error&gt;
    <span class="hljs-keyword">where</span> T: Deserialize + <span class="hljs-built_in">Ord</span>,
          D: Deserializer
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">MaxVisitor</span></span>&lt;T&gt;(PhantomData&lt;T&gt;);

    <span class="hljs-keyword">impl</span>&lt;T&gt; de::Visitor <span class="hljs-keyword">for</span> MaxVisitor&lt;T&gt;
        <span class="hljs-keyword">where</span> T: Deserialize + <span class="hljs-built_in">Ord</span>
    {
        <span class="hljs-comment">/// Return type of this visitor. This visitor computes the max of a</span>
        <span class="hljs-comment">/// sequence of values of type T, so the type of the maximum is T.</span>
        <span class="hljs-class"><span class="hljs-keyword">type</span> <span class="hljs-title">Value</span></span> = T;

        <span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">visit_seq</span></span>&lt;V&gt;(&amp;<span class="hljs-keyword">mut</span> <span class="hljs-keyword">self</span>, <span class="hljs-keyword">mut</span> visitor: V) -&gt; <span class="hljs-built_in">Result</span>&lt;T, V::Error&gt;
            <span class="hljs-keyword">where</span> V: de::SeqVisitor
        {
            <span class="hljs-comment">// Start with max equal to the first value in the seq.</span>
            <span class="hljs-keyword">let</span> <span class="hljs-keyword">mut</span> max = <span class="hljs-keyword">match</span> <span class="hljs-built_in">try!</span>(visitor.visit()) {
                <span class="hljs-literal">Some</span>(value) =&gt; value,
                <span class="hljs-literal">None</span> =&gt; {
                    <span class="hljs-comment">// Cannot take the maximum of an empty seq.</span>
                    <span class="hljs-keyword">let</span> msg = <span class="hljs-string">&quot;no values in seq when looking for maximum&quot;</span>;
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">Err</span>(de::Error::custom(msg));
                }
            };

            <span class="hljs-comment">// Update the max while there are additional values.</span>
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> <span class="hljs-literal">Some</span>(value) = <span class="hljs-built_in">try!</span>(visitor.visit()) {
                max = cmp::max(max, value);
            }

            <span class="hljs-built_in">try!</span>(visitor.end());
            <span class="hljs-literal">Ok</span>(max)
        }
    }

    <span class="hljs-comment">// Create the visitor and ask the deserializer to drive it. The</span>
    <span class="hljs-comment">// deserializer will call visitor.visit_seq if a seq is present in</span>
    <span class="hljs-comment">// the input data.</span>
    <span class="hljs-keyword">let</span> visitor = MaxVisitor(PhantomData);
    deserializer.deserialize_seq(visitor)
}

<span class="hljs-function"><span class="hljs-keyword">fn</span> <span class="hljs-title">main</span></span>() {
    <span class="hljs-keyword">let</span> j = r#<span class="hljs-string">&quot;
        {
          &quot;</span>id<span class="hljs-string">&quot;: &quot;</span>demo-deserialize-max<span class="hljs-string">&quot;,
          &quot;</span>values<span class="hljs-string">&quot;: [
            256,
            100,
            384,
            314,
            271
          ]
        }
    &quot;</span>#;

    <span class="hljs-keyword">let</span> out: Outer = serde_json::from_str(j).unwrap();

    <span class="hljs-comment">// Prints &quot;max value: 384&quot;</span>
    <span class="hljs-built_in">println!</span>(<span class="hljs-string">&quot;max value: {}&quot;</span>, out.max_value);
}
</code></pre>

                                
                                </section>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="serialize-map.html" class="navigation navigation-prev " aria-label="Previous page: Serialize for custom map type">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="enum-str.html" class="navigation navigation-next " aria-label="Next page: Serialize enum as string">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Array of values without buffering","level":"1.6.6","depth":2,"next":{"title":"Serialize enum as string","level":"1.6.7","depth":2,"path":"enum-str.md","ref":"enum-str.md","articles":[]},"previous":{"title":"Serialize for custom map type","level":"1.6.5","depth":2,"path":"serialize-map.md","ref":"serialize-map.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-search","-sharing","codeblock-filename","edit-link","ga"],"root":"src","styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"edit-link":{"label":"Edit","base":"https://github.com/serde-rs/serde-rs.github.io/edit/master/src"},"ga":{"configuration":"auto","token":"UA-82804814-1"},"codeblock-filename":{},"highlight":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Serde","language":"en","gitbook":"*"},"file":{"path":"stream-array.md","mtime":"2016-10-08T23:47:02.507Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2016-12-27T04:39:33.586Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ga/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

